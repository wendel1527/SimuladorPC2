@page
@model IndexModel
@{
    ViewData["Title"] = "Home page";
}

@{
    ViewBag.Title = "Simulador Mini-ISA";
}

<link rel="stylesheet" href="~/css/simulador.css" />

<div class="d-flex flex-column justify-content-center w-100 h-100">
    <div class="d-flex flex-column justify-content-center align-items-center">
        <h1 class="estilo">Simulador de Arquitetura</h1>

        <label for="programa">Insira o programa em Assembly</label><br>

        <textarea id="programa" rows="10" cols="50" placeholder="Exemplo:
LI x1, 10
LI x2, 20
ADD x3, x1, x2
SW x3, 0(x0)">
        </textarea><br>

        <button class="botao" onclick="ExecutarPrograma()">Executar</button>

        <h2>Resultado da Simulação</h2>
        <div class="log-wrapper">
            <table id="logExecucao" class="log-table">
                <thead>
                    <tr>
                        <th class="log-cycle">Ciclo</th>
                        <th class="log-instr">Instrução</th>
                        <th>Detalhes</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- linhas serão inseridas via JS -->
                </tbody>
            </table>
        </div>

        <h2>Métricas</h2>
        <div id="metricas" class="metrics-grid"></div>
    </div>
</div>

<script>function escapeHtml(s){
        return s
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;');
    }

    function ExecutarPrograma() {
        const programa = document.getElementById("programa").value;

        fetch(`/Simulador/Executar`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ codigo: programa })
        })
        .then(r => r.json())
        .then(data => {
            // Exibe métricas em grid
            const container = document.getElementById("metricas");
            container.innerHTML = '';

            const metrics = [
                { label: 'Ciclos totais', value: data.metricas.ciclos },
                { label: 'IPC', value: data.metricas.ipc },
                { label: 'Cache hits', value: data.metricas.hits },
                { label: 'Cache misses', value: data.metricas.misses }
            ];

            metrics.forEach(m => {
                const item = document.createElement('div');
                item.className = 'metric';
                item.innerHTML = `<div class="metric-label">${m.label}</div><div class="metric-value">${m.value}</div>`;
                container.appendChild(item);
            });

            // Exibe log ciclo-a-ciclo em grid (cada row por ciclo)
            const tableBody = document.querySelector('#logExecucao tbody');
            tableBody.innerHTML = '';

            let rawLines = [];
            if (Array.isArray(data.log)) rawLines = data.log.slice();
            else if (typeof data.log === 'string') rawLines = data.log.split(/\r?\n/);

            let currentRow = null;

            rawLines.forEach(line => {
                if (!line || !line.trim()) return; // pular vazios

                const cycleMatch = line.match(/^\s*Cycle\s+(\d+)\s*:\s*(.*)$/i);
                if (cycleMatch) {
                    // nova linha/row para este ciclo
                    const cycle = cycleMatch[1];
                    const instr = cycleMatch[2] || '';
                    currentRow = document.createElement('tr');

                    const tdCycle = document.createElement('td');
                    tdCycle.className = 'log-cycle';
                    tdCycle.textContent = cycle;

                    const tdInstr = document.createElement('td');
                    tdInstr.className = 'log-instr';
                    tdInstr.textContent = instr;

                    const tdDetails = document.createElement('td');
                    tdDetails.className = 'log-details';
                    tdDetails.textContent = '';

                    currentRow.appendChild(tdCycle);
                    currentRow.appendChild(tdInstr);
                    currentRow.appendChild(tdDetails);

                    tableBody.appendChild(currentRow);
                } else {
                    // linha de detalhe (por exemplo " LI x1 = 10") -> adiciona ao último row
                    if (!currentRow) return; // sem ciclo anterior, ignora
                    const tdDetails = currentRow.querySelector('.log-details');
                    // remover prefixos de espaço para exibir melhor
                    const trimmed = line.replace(/^\s+/, '');
                    // concatenar com quebra de linha preservada
                    tdDetails.innerHTML = tdDetails.innerHTML
                        ? tdDetails.innerHTML + '<br>' + escapeHtml(trimmed)
                        : escapeHtml(trimmed);
                }
            });

            // Se não houver linhas por ciclo, exibe mensagem
            if (!tableBody.querySelector('tr')) {
                const tr = document.createElement('tr');
                const td = document.createElement('td');
                td.colSpan = 3;
                td.textContent = 'Nenhum log disponível.';
                tr.appendChild(td);
                tableBody.appendChild(tr);
            }
        });
    }</script>